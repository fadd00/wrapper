---
import Layout from "../layouts/Layout.astro";
---

<Layout title="Dashboard - Wrapper API">
    <div class="py-12 min-h-[calc(100vh-8rem)]">
        <div class="container">
            <div class="flex items-start justify-between mb-8 flex-wrap gap-4">
                <div>
                    <h1 class="text-4xl font-bold mb-2">Dashboard</h1>
                    <p id="userEmail" class="text-text-tertiary">Loading...</p>
                </div>
                <button
                    id="logoutBtn"
                    class="px-6 py-2.5 bg-dark-bg-tertiary border border-dark-border-light text-text-primary font-semibold rounded-lg hover:border-accent transition-colors"
                    >Logout</button
                >
            </div>

            <div class="grid gap-8">
                <!-- API Keys Section -->
                <div
                    class="p-6 bg-dark-bg-tertiary rounded-lg border border-dark-border-light"
                >
                    <div
                        class="flex items-center justify-between mb-6 flex-wrap gap-4"
                    >
                        <h2 class="text-2xl font-bold m-0">API Keys</h2>
                        <button
                            id="generateKeyBtn"
                            class="px-6 py-2.5 bg-accent text-dark-bg font-semibold rounded-lg hover:bg-accent/90 transition-colors"
                        >
                            <span>+ Generate New Key</span>
                        </button>
                    </div>

                    <div id="apiKeysList" class="flex flex-col gap-4">
                        <p class="text-center text-text-tertiary py-8">
                            Loading your API keys...
                        </p>
                    </div>
                </div>

                <!-- Send Test Receipt Section -->
                <div
                    class="p-6 bg-dark-bg-tertiary rounded-lg border border-dark-border-light"
                >
                    <h2 class="text-2xl font-bold mb-2">Send Test Receipt</h2>
                    <p class="text-text-tertiary mb-4">
                        Test your API by sending a receipt email
                    </p>

                    <form id="sendReceiptForm" class="flex flex-col gap-4">
                        <div class="flex flex-col gap-2">
                            <label
                                for="item"
                                class="text-sm font-semibold text-text-primary"
                                >Item Name</label
                            >
                            <input
                                type="text"
                                id="item"
                                name="item"
                                placeholder="e.g., Laptop"
                                required
                                class="px-4 py-2.5 bg-dark-bg-secondary border border-dark-border rounded-lg text-text-primary placeholder:text-text-tertiary focus:outline-none focus:border-accent transition-colors"
                            />
                        </div>

                        <div class="flex flex-col gap-2">
                            <label
                                for="harga"
                                class="text-sm font-semibold text-text-primary"
                                >Price (numbers only)</label
                            >
                            <input
                                type="text"
                                id="harga"
                                name="harga"
                                placeholder="e.g., 5000000"
                                pattern="[0-9]+"
                                required
                                class="px-4 py-2.5 bg-dark-bg-secondary border border-dark-border rounded-lg text-text-primary placeholder:text-text-tertiary focus:outline-none focus:border-accent transition-colors"
                            />
                        </div>

                        <div class="flex flex-col gap-2">
                            <label
                                for="email"
                                class="text-sm font-semibold text-text-primary"
                                >Recipient Email</label
                            >
                            <input
                                type="email"
                                id="email"
                                name="email"
                                placeholder="customer@example.com"
                                required
                                class="px-4 py-2.5 bg-dark-bg-secondary border border-dark-border rounded-lg text-text-primary placeholder:text-text-tertiary focus:outline-none focus:border-accent transition-colors"
                            />
                        </div>

                        <div
                            id="receiptError"
                            class="hidden p-3 bg-error/10 border border-error rounded-lg text-error text-sm"
                        >
                        </div>
                        <div
                            id="receiptSuccess"
                            class="hidden p-3 bg-success/10 border border-success rounded-lg text-success text-sm"
                        >
                        </div>

                        <button
                            type="submit"
                            class="w-full flex items-center justify-center px-6 py-3 bg-accent text-dark-bg font-semibold rounded-lg hover:bg-accent/90 transition-colors"
                        >
                            <span id="sendButtonText">Send Receipt</span>
                            <span
                                id="sendSpinner"
                                class="hidden inline-block w-4 h-4 border-2 border-dark-bg border-t-transparent rounded-full animate-spin ml-2"
                            ></span>
                        </button>
                    </form>
                </div>

                <!-- Request History Section -->
                <div
                    class="p-6 bg-dark-bg-tertiary rounded-lg border border-dark-border-light"
                >
                    <h2 class="text-2xl font-bold mb-0">Request History</h2>
                    <div id="logsTable" class="flex flex-col gap-4 mt-6">
                        <p class="text-center text-text-tertiary py-8">
                            Loading request history...
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</Layout>

<script>
    const apiUrl = import.meta.env.PUBLIC_API_URL || "http://localhost:3000";

    // Check authentication
    const token = localStorage.getItem("token");
    const userStr = localStorage.getItem("user");

    if (!token || !userStr) {
        window.location.href = "/login";
    }

    const user = JSON.parse(userStr!);
    document.getElementById("userEmail")!.textContent = user.email;

    // Logout
    document.getElementById("logoutBtn")!.addEventListener("click", () => {
        localStorage.removeItem("token");
        localStorage.removeItem("user");
        window.location.href = "/";
    });

    // Load API keys
    async function loadApiKeys() {
        try {
            const response = await fetch(`${apiUrl}/api-keys/list`, {
                headers: { Authorization: `Bearer ${token}` },
            });
            const data = await response.json();

            const container = document.getElementById("apiKeysList")!;

            if (data.data.length === 0) {
                container.innerHTML =
                    '<p class="text-center text-text-tertiary py-8">No API keys yet. Generate your first one!</p>';
                currentApiKey = null;
                return;
            }

            // Store first active key for send receipt form
            const activeKey = data.data.find((k: any) => k.isActive);
            currentApiKey = activeKey ? activeKey.key : null;

            container.innerHTML = data.data
                .map(
                    (key: any) => `
        <div class="flex items-center justify-between p-4 bg-dark-bg border border-dark-border-light rounded-lg gap-4 flex-wrap">
          <code class="font-mono text-[15px] text-accent flex-1 break-all">${key.key}</code>
          <div class="flex gap-3">
            <button class="copy-key px-4 py-2 text-sm bg-dark-bg-tertiary border border-dark-border-light text-text-primary font-semibold rounded-lg hover:border-accent transition-colors" data-key="${key.key}">Copy</button>
            ${key.isActive ? `<button class="revoke-key px-4 py-2 text-sm bg-dark-bg-tertiary border border-dark-border-light text-text-primary font-semibold rounded-lg hover:border-accent transition-colors" data-id="${key.id}">Revoke</button>` : '<span class="text-text-tertiary">Revoked</span>'}
          </div>
        </div>
      `,
                )
                .join("");

            // Copy buttons
            document.querySelectorAll(".copy-key").forEach((btn) => {
                btn.addEventListener("click", async (e) => {
                    const key = (e.target as HTMLElement).getAttribute(
                        "data-key",
                    )!;
                    await navigator.clipboard.writeText(key);
                    (e.target as HTMLElement).textContent = "Copied!";
                    setTimeout(() => {
                        (e.target as HTMLElement).textContent = "Copy";
                    }, 2000);
                });
            });

            // Revoke buttons
            document.querySelectorAll(".revoke-key").forEach((btn) => {
                btn.addEventListener("click", async (e) => {
                    const id = (e.target as HTMLElement).getAttribute(
                        "data-id",
                    )!;
                    if (
                        confirm("Are you sure you want to revoke this API key?")
                    ) {
                        await fetch(`${apiUrl}/api-keys/revoke/${id}`, {
                            method: "PATCH",
                            headers: { Authorization: `Bearer ${token}` },
                        });
                        loadApiKeys();
                    }
                });
            });
        } catch (error) {
            document.getElementById("apiKeysList")!.innerHTML =
                '<p class="text-center text-error py-8">Failed to load API keys</p>';
        }
    }

    // Generate new key
    document
        .getElementById("generateKeyBtn")!
        .addEventListener("click", async () => {
            try {
                await fetch(`${apiUrl}/api-keys/generate`, {
                    method: "POST",
                    headers: { Authorization: `Bearer ${token}` },
                });
                loadApiKeys();
            } catch (error) {
                alert("Failed to generate API key");
            }
        });

    // Load logs
    async function loadLogs() {
        try {
            const response = await fetch(`${apiUrl}/logs`, {
                headers: { Authorization: `Bearer ${token}` },
            });
            const data = await response.json();

            const container = document.getElementById("logsTable")!;

            if (data.data.length === 0) {
                container.innerHTML =
                    '<p class="text-center text-text-tertiary py-8">No request history yet.</p>';
                return;
            }

            container.innerHTML = data.data
                .map(
                    (log: any) => `
        <div class="grid grid-cols-1 md:grid-cols-[auto_1fr_auto_auto] gap-4 p-3 bg-dark-bg border border-dark-border-light rounded-lg text-sm items-center">
          <span class="px-3 py-1 rounded-full text-xs font-semibold uppercase ${log.status === "success" ? "bg-success/10 text-success" : "bg-error/10 text-error"}">${log.status}</span>
          <code class="font-mono">${log.endpoint}</code>
          <span class="text-text-tertiary text-[13px]">${new Date(log.timestamp).toLocaleString()}</span>
          <code class="text-text-tertiary font-mono">${log.apiKey}</code>
        </div>
      `,
                )
                .join("");
        } catch (error) {
            document.getElementById("logsTable")!.innerHTML =
                '<p class="text-center text-error py-8">Failed to load logs</p>';
        }
    }

    // Send receipt handler
    let currentApiKey: string | null = null;

    document
        .getElementById("sendReceiptForm")!
        .addEventListener("submit", async (e) => {
            e.preventDefault();

            const errorDiv = document.getElementById("receiptError")!;
            const successDiv = document.getElementById("receiptSuccess")!;
            const buttonText = document.getElementById("sendButtonText")!;
            const spinner = document.getElementById("sendSpinner")!;

            errorDiv.classList.add("hidden");
            successDiv.classList.add("hidden");

            // Get first active API key
            if (!currentApiKey) {
                errorDiv.textContent = "Please generate an API key first";
                errorDiv.classList.remove("hidden");
                return;
            }

            const formData = new FormData(e.target as HTMLFormElement);
            const data = {
                item: formData.get("item") as string,
                harga: formData.get("harga") as string,
                email: formData.get("email") as string,
            };

            // Show loading
            buttonText.style.display = "none";
            spinner.classList.remove("hidden");

            try {
                const response = await fetch(`${apiUrl}/api/send-receipt`, {
                    method: "POST",
                    headers: {
                        "X-API-Key": currentApiKey,
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify(data),
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.message || "Failed to send receipt");
                }

                successDiv.textContent = `Receipt sent successfully to ${data.email}!`;
                successDiv.classList.remove("hidden");

                // Reset form
                (e.target as HTMLFormElement).reset();

                // Reload logs to show new entry
                setTimeout(() => loadLogs(), 1000);
            } catch (error: any) {
                errorDiv.textContent = error.message;
                errorDiv.classList.remove("hidden");
            } finally {
                buttonText.style.display = "inline";
                spinner.classList.add("hidden");
            }
        });

    // Initial load
    loadApiKeys();
    loadLogs();
</script>
